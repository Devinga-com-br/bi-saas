# M√≥dulo de Metas - Documenta√ß√£o Completa

## ‚úÖ Status
O m√≥dulo de Metas foi **CRIADO E TESTADO** com sucesso! O build passou sem erros.

### O que est√° pronto:
- ‚úÖ Migration criada em `supabase/migrations/024_create_metas_table.sql`
- ‚úÖ Tabela `metas_mensais` por schema (multi-tenant)
- ‚úÖ Fun√ß√µes RPC no Supabase
- ‚úÖ API Routes (`/api/metas/generate` e `/api/metas/report`)
- ‚úÖ Interface completa em `/metas/mensal`
- ‚úÖ Menu integrado no sidebar
- ‚úÖ Build funcionando sem erros

## üìÅ Arquivos Criados/Modificados

### 1. Migration (Banco de Dados)
**Arquivo**: `supabase/migrations/024_create_metas_table.sql`

Cria:
- Fun√ß√£o `public.create_metas_table_for_tenant(schema_name)` - Cria tabela por schema
- Fun√ß√£o `public.generate_metas_mensais()` - Gera metas mensais automaticamente
- Fun√ß√£o `public.get_metas_mensais_report()` - Busca relat√≥rio de metas
- Tabela `{schema}.metas_mensais` para cada tenant existente
- √çndices para performance
- Triggers para `updated_at`

### 2. API Routes
**Arquivo**: `src/app/api/metas/generate/route.ts`
- Endpoint: `POST /api/metas/generate`
- Fun√ß√£o: Gerar metas mensais para uma filial
- Par√¢metros: `schema`, `filialId`, `mes`, `ano`, `metaPercentual`, `dataReferenciaInicial`

**Arquivo**: `src/app/api/metas/report/route.ts`
- Endpoint: `GET /api/metas/report`
- Fun√ß√£o: Buscar relat√≥rio de metas
- Par√¢metros: `schema`, `mes`, `ano`, `filialId` (opcional)

### 3. Interface do Usu√°rio
**Arquivo**: `src/app/(dashboard)/metas/mensal/page.tsx`
- P√°gina completa de Metas Mensais
- Cards de resumo (Vendas vs Meta)
- Gr√°fico circular de progresso
- Tabela detalhada dia a dia
- Filtros (M√™s, Ano, Filial)
- Dialog para cadastrar novas metas

### 4. Menu/Navega√ß√£o
**Arquivo**: `src/components/dashboard/app-sidebar.tsx`
- Adicionado item "Metas" com √≠cone TrendingUp
- Subitem "Meta Mensal" linkando para `/metas/mensal`

## üöÄ Como Aplicar a Migration

**IMPORTANTE**: A migration precisa ser aplicada no banco de dados antes de usar o m√≥dulo.

### Op√ß√£o 1: Via Supabase Dashboard (Recomendado)
1. Acesse [Supabase Dashboard](https://supabase.com/dashboard)
2. Selecione seu projeto
3. V√° em **SQL Editor** no menu lateral
4. Clique em "New Query"
5. Cole o conte√∫do completo do arquivo `supabase/migrations/024_create_metas_table.sql`
6. Clique em "Run" ou pressione Ctrl+Enter
7. Verifique se n√£o houve erros

### Op√ß√£o 2: Via CLI do Supabase
```bash
# Se voc√™ tem o Supabase CLI instalado
supabase db push

# Ou aplicar migration espec√≠fica
supabase migration up --db-url "sua-connection-string"
```

### Op√ß√£o 3: Via psql
```bash
psql "sua-connection-string" -f supabase/migrations/024_create_metas_table.sql
```

### Verificar se foi aplicada corretamente
Execute no SQL Editor:
```sql
-- Verificar se a fun√ß√£o foi criada
SELECT proname FROM pg_proc WHERE proname = 'create_metas_table_for_tenant';

-- Verificar se a tabela existe para o schema 'okilao' (exemplo)
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'okilao' AND table_name = 'metas_mensais';
```

## O Que a Migration Faz

1. **Cria fun√ß√£o `create_metas_table_for_tenant`**
   - Cria tabela `metas_mensais` em cada schema de tenant
   - Adiciona √≠ndices para performance
   - Configura triggers para `updated_at`

2. **Cria fun√ß√£o `generate_metas_mensais`**
   - Gera metas di√°rias para um m√™s espec√≠fico
   - Calcula valores de refer√™ncia do ano anterior
   - Calcula valores realizados
   - Calcula diferen√ßas e percentuais
   - Define situa√ß√£o (positiva/negativa/neutra/pendente)

3. **Cria fun√ß√£o `get_metas_mensais_report`**
   - Busca metas de um per√≠odo
   - Calcula totais acumulados
   - Calcula percentual atingido

4. **Aplica automaticamente aos schemas existentes**

## Estrutura da Tabela `metas_mensais`

```sql
CREATE TABLE schema.metas_mensais (
  id bigserial PRIMARY KEY,
  filial_id bigint NOT NULL,
  data date NOT NULL,
  dia_semana text NOT NULL,
  meta_percentual numeric(5, 2) NOT NULL DEFAULT 0,
  data_referencia date NOT NULL,
  valor_referencia numeric(15, 2) DEFAULT 0,
  valor_meta numeric(15, 2) DEFAULT 0,
  valor_realizado numeric(15, 2) DEFAULT 0,
  diferenca numeric(15, 2) DEFAULT 0,
  diferenca_percentual numeric(5, 2) DEFAULT 0,
  situacao text DEFAULT 'pendente',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  CONSTRAINT metas_mensais_unique_filial_data UNIQUE (filial_id, data)
);
```

## Funcionalidades

### 1. Cadastro de Metas
- Selecionar m√™s e ano
- Selecionar filial
- Definir percentual de meta (ex: 10% = meta de crescer 10% em rela√ß√£o ao ano anterior)
- Definir data de refer√™ncia inicial (primeiro dia do per√≠odo de compara√ß√£o)
- Gera automaticamente metas para todos os dias do m√™s

### 2. Visualiza√ß√£o
- Card com vendas do per√≠odo vs meta
- Gr√°fico circular de progresso da meta
- Tabela detalhada dia a dia com:
  - Data e dia da semana
  - Data de refer√™ncia
  - Meta (% e valor)
  - Valor realizado
  - Diferen√ßa (valor e %)
  - Situa√ß√£o (badge colorido)

### 3. Filtros
- M√™s (padr√£o: m√™s atual)
- Ano (padr√£o: ano atual)  
- Filial (padr√£o: todas)

## üêõ Troubleshooting

### Erro: "Fun√ß√£o n√£o encontrada"
**Sintoma**: Erro no console `function "generate_metas_mensais" does not exist`

**Solu√ß√£o**:
1. A migration n√£o foi aplicada
2. Aplique a migration conforme instru√ß√µes acima
3. Reinicie o servidor Next.js

### Erro: "Tabela n√£o existe"
**Sintoma**: `relation "schema.metas_mensais" does not exist`

**Solu√ß√£o**:
1. Execute no SQL Editor:
```sql
SELECT public.create_metas_table_for_tenant('seu_schema');
```
2. Substitua `'seu_schema'` pelo schema do seu tenant (ex: `'okilao'`)

### Nenhuma meta √© gerada
**Poss√≠veis causas**:
1. **Sem dados de refer√™ncia**: N√£o h√° vendas no ano anterior
   - Verifique: `SELECT * FROM {schema}.vendas_diarias_por_filial WHERE data_venda BETWEEN '2024-10-01' AND '2024-10-31'`
2. **Filial inexistente**: ID de filial inv√°lido
   - Verifique: `SELECT * FROM public.branches WHERE branch_code = 'X'`

### Valores zerados
**Causa**: N√£o h√° vendas registradas para o per√≠odo

**Solu√ß√£o**:
- Aguarde o fechamento do dia para que vendas sejam registradas em `vendas_diarias_por_filial`
- Ou verifique se a integra√ß√£o de vendas est√° funcionando

### Erro de permiss√£o
**Sintoma**: `permission denied for function generate_metas_mensais`

**Solu√ß√£o**:
- Fun√ß√µes s√£o `SECURITY DEFINER`, mas verifique se usu√°rio est√° autenticado
- Reaplique migration se necess√°rio

## ‚ùì FAQ

### 1. Posso alterar a meta depois de criada?
Sim! Basta gerar novamente com o novo percentual. O sistema usa `ON CONFLICT ... DO UPDATE`, ent√£o os valores ser√£o atualizados.

### 2. Como funciona a compara√ß√£o com ano anterior?
A data de refer√™ncia inicial define o ponto de partida. Para cada dia do m√™s atual, o sistema busca o valor vendido no dia correspondente do ano anterior.

Exemplo:
- Meta para: 15/10/2025
- Data ref. inicial: 01/10/2024
- Data ref. calculada: 15/10/2024 (14 dias depois)
- Valor ref.: Vendas de 15/10/2024

### 3. Posso ter metas diferentes por filial?
Sim! Cada filial pode ter seu pr√≥prio percentual de meta. Basta cadastrar separadamente.

### 4. O que acontece se n√£o houver vendas no ano anterior?
- `valor_referencia` = 0
- `valor_meta` = 0
- Meta n√£o faz sentido para esse dia
- Recomenda-se definir meta manualmente nesses casos

### 5. Como as metas s√£o atualizadas diariamente?
As metas s√£o **est√°ticas** ap√≥s cria√ß√£o. Para atualizar `valor_realizado` diariamente:

**Op√ß√£o 1**: Reexecutar gera√ß√£o (sobrescreve)
**Op√ß√£o 2**: Criar um job/cron para atualizar:
```sql
-- Atualizar valores realizados para m√™s atual
UPDATE {schema}.metas_mensais m
SET 
  valor_realizado = (
    SELECT COALESCE(valor_total, 0)
    FROM {schema}.vendas_diarias_por_filial
    WHERE filial_id = m.filial_id AND data_venda = m.data
  ),
  updated_at = now()
WHERE EXTRACT(YEAR FROM data) = EXTRACT(YEAR FROM CURRENT_DATE)
  AND EXTRACT(MONTH FROM data) = EXTRACT(MONTH FROM CURRENT_DATE);
```

### 6. Posso exportar o relat√≥rio?
Atualmente n√£o implementado, mas pode ser adicionado:
- Exportar para Excel via biblioteca xlsx
- Exportar para PDF via jsPDF
- Imprimir usando `window.print()`

### 7. Como configurar meta para "todas as filiais"?
Para ter uma meta consolidada:
1. Cadastre meta para cada filial individualmente
2. Use o filtro "Todas as Filiais" para visualizar o consolidado
3. Os totais ser√£o somados automaticamente

## üìù Pr√≥ximos Passos / Melhorias Futuras

- [ ] Atualiza√ß√£o autom√°tica de `valor_realizado` via cronjob
- [ ] Exporta√ß√£o para Excel/PDF
- [ ] Gr√°fico de evolu√ß√£o di√°ria vs meta
- [ ] Notifica√ß√µes quando meta √© atingida/n√£o atingida
- [ ] Compara√ß√£o de metas entre filiais
- [ ] Hist√≥rico de altera√ß√µes de meta
- [ ] Meta por categoria/departamento
- [ ] Meta semanal al√©m de mensal
- [ ] Dashboard executivo com resumo geral

## üìû Suporte

Se encontrar problemas:
1. Verifique os logs do console do navegador
2. Verifique os logs do servidor Next.js
3. Verifique os logs do Supabase (SQL Editor)
4. Consulte este README completo

---

**Data de Cria√ß√£o**: 15 de Outubro de 2025  
**√öltima Atualiza√ß√£o**: 15 de Outubro de 2025  
**Vers√£o**: 1.0.0

## üí° Como Usar o M√≥dulo

### 1. Primeira Vez - Cadastrar Metas
1. Acesse o menu **"Metas"** ‚Üí **"Meta Mensal"**
2. Clique no bot√£o **"+ Cadastrar Meta"**
3. Preencha o formul√°rio:
   - **M√™s**: Selecione o m√™s desejado (ex: Outubro)
   - **Ano**: Selecione o ano (ex: 2025)
   - **Filial**: Escolha a filial (ex: Filial 1)
   - **Meta (%)**: Digite o percentual de crescimento (ex: 10 para 10%)
   - **Data de Refer√™ncia Inicial**: Data inicial do per√≠odo de compara√ß√£o (ex: 2024-10-01)
4. Clique em **"Gerar Metas"**
5. O sistema ir√°:
   - Criar uma meta para cada dia do m√™s selecionado
   - Buscar os valores de venda do ano anterior (data de refer√™ncia)
   - Calcular o valor meta baseado no percentual informado
   - Buscar os valores realizados (se j√° existirem vendas)
   - Calcular as diferen√ßas automaticamente

### 2. Acompanhar Metas
Ap√≥s cadastrar, voc√™ ver√°:

**Card de Vendas do Per√≠odo**
- Valor total realizado no m√™s at√© o momento
- Valor da meta acumulada
- Percentual de diferen√ßa (verde se positivo, vermelho se negativo)

**Card de Progresso**
- Gr√°fico circular mostrando % da meta atingida
- Verde se atingiu 100% ou mais
- Azul se ainda est√° abaixo de 100%

**Tabela Detalhada**
Para cada dia do m√™s:
- Data e dia da semana (em portugu√™s)
- Data de refer√™ncia do ano anterior
- Meta em % e valor esperado (R$)
- Valor realizado no dia (R$)
- Diferen√ßa em valor e percentual
- Badge de situa√ß√£o:
  - üü¢ **Positiva**: Atingiu ou superou a meta
  - üü° **Neutra**: Ficou at√© 5% abaixo da meta
  - üî¥ **Negativa**: Ficou mais de 5% abaixo da meta
  - ‚ö™ **Pendente**: Data futura (sem vendas ainda)

### 3. Filtrar Visualiza√ß√£o
Use os filtros para analisar:
- **M√™s/Ano**: Altere para ver metas de outros per√≠odos
- **Filial**: Veja meta de uma filial espec√≠fica ou de todas juntas
- Clique em **"Aplicar"** para atualizar

### 4. Recalcular/Atualizar Metas
- Se gerar metas novamente para o mesmo per√≠odo e filial, os valores ser√£o **atualizados**
- √ötil para:
  - Alterar o percentual de meta
  - Corrigir data de refer√™ncia
  - Recalcular ap√≥s novas vendas

## üîß Detalhes T√©cnicos

### Arquitetura Multi-Tenant
- Tabela `metas_mensais` criada **por schema** (um para cada empresa/tenant)
- Fun√ß√µes RPC centralizadas em `public` schema
- Par√¢metro `p_schema` passado para as fun√ß√µes para isolar dados

### C√°lculo das Metas

#### Valor Meta
```
valor_meta = valor_referencia √ó (1 + (meta_percentual / 100))
```

Exemplo:
- Valor de refer√™ncia (ano anterior): R$ 10.000,00
- Meta: 10%
- Valor meta = 10.000 √ó (1 + 0.10) = R$ 11.000,00

#### Diferen√ßa
```
diferenca = valor_realizado - valor_meta
```

#### Diferen√ßa Percentual
```
diferenca_percentual = (diferenca / valor_meta) √ó 100
```

#### Situa√ß√£o
- **Pendente**: `data > CURRENT_DATE`
- **Positiva**: `diferenca >= 0`
- **Neutra**: `diferenca < 0 AND diferenca >= (valor_meta √ó -0.05)`
- **Negativa**: `diferenca < (valor_meta √ó -0.05)`

### Performance

#### √çndices Criados
```sql
-- Por filial e data (queries principais)
CREATE INDEX idx_metas_mensais_filial_data ON metas_mensais(filial_id, data);

-- Por data (agrega√ß√µes)
CREATE INDEX idx_metas_mensais_data ON metas_mensais(data);
```

#### Constraint √önico
```sql
-- Impede duplicatas
CONSTRAINT metas_mensais_unique_filial_data UNIQUE (filial_id, data)
```

### Depend√™ncias
O m√≥dulo depende de:
- Tabela `{schema}.vendas_diarias_por_filial` (j√° existente)
- Tabela `public.branches` (para listar filiais)
- Contexto de tenant (`useTenantContext`)

### Formato de Datas
- **Entrada**: `YYYY-MM-DD` (ISO 8601)
- **Exibi√ß√£o**: `dd/MM/yyyy` (brasileiro)
- **Dia da semana**: Em portugu√™s (Segunda-Feira, Ter√ßa-Feira, etc.)

### API Response Format

#### GET /api/metas/report
```typescript
{
  metas: [
    {
      id: number
      filial_id: number
      data: string // "2025-10-01"
      dia_semana: string // "Ter√ßa-Feira"
      meta_percentual: number // 10.00
      data_referencia: string // "2024-10-01"
      valor_referencia: number // 10000.00
      valor_meta: number // 11000.00
      valor_realizado: number // 11500.00
      diferenca: number // 500.00
      diferenca_percentual: number // 4.55
      situacao: string // "positiva"
    }
  ],
  total_realizado: number // 350000.00
  total_meta: number // 330000.00
  percentual_atingido: number // 106.06
}
```

#### POST /api/metas/generate
```typescript
{
  success: boolean
  message: string // "Metas geradas com sucesso"
  dias_processados: number // 31
}
```
